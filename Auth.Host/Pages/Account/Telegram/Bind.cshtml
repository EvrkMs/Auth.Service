@page
@model Auth.Host.Pages.Account.Telegram.BindModel
@{
    ViewData["Title"] = "Привязка Telegram";
    Layout = null;
}

<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Ava Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
    <div class="min-h-screen flex items-center justify-center py-10 px-6">
        <div class="w-full max-w-xl bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl">
            <div class="mb-6 text-center">
                <h1 class="text-3xl font-semibold">Привязка Telegram</h1>
                <p class="text-sm text-slate-400 mt-2">Подтвердите пароль и авторизуйтесь через Telegram, чтобы связать аккаунт</p>
            </div>
            @if (string.IsNullOrWhiteSpace(Model.BotUsername))
            {
                <div class="bg-red-500/10 border border-red-500/40 text-red-200 text-sm rounded-xl px-4 py-3">
                    Telegram-бот не настроен. Обратитесь к администратору.
                </div>
            }
            else
            {
                <form class="space-y-6" onsubmit="submitTelegramBind(event)">
                    <div>
                        <label class="text-sm font-medium text-slate-300">Пароль</label>
                        <input id="password-input" type="password" class="mt-1 w-full px-4 py-3 bg-slate-800/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="Введите пароль" required />
                        <p class="text-xs text-slate-400 mt-1">Пароль требуется для подтверждения привязки.</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-300 mb-3">1. Авторизуйтесь через Telegram:</p>
                        <div class="flex justify-center" id="telegram-widget">
                            <script async src="https://telegram.org/js/telegram-widget.js?22"
                                    data-telegram-login="@Model.BotUsername"
                                    data-size="large"
                                    data-request-access="write"
                                    data-onauth="handleTelegramAuth"></script>
                        </div>
                    </div>
                    <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
                        <p class="text-sm text-slate-300 mb-2">2. Нажмите «Привязать Telegram» после успешной авторизации.</p>
                        <p id="status" class="text-sm text-slate-400">Telegram пока не подтверждён.</p>
                    </div>
                    <div class="space-y-2">
                        <button id="bind-button" type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-500 font-semibold text-white shadow-lg shadow-purple-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                            Привязать Telegram
                        </button>
                        <a class="block text-center text-sm text-slate-400 hover:text-white" href="@Model.SafeReturnUrl">Вернуться назад</a>
                    </div>
                </form>
            }
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const bindButton = document.getElementById('bind-button');
        const passwordInput = document.getElementById('password-input');
        let telegramUser = null;

        function setStatus(message, isError = false) {
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.classList.toggle('text-red-300', isError);
            statusEl.classList.toggle('text-slate-400', !isError);
        }

        window.handleTelegramAuth = function (user) {
            telegramUser = user;
            const label = user.username ? '@' + user.username : user.first_name || 'Telegram пользователь';
            setStatus(`Подтверждён аккаунт ${label}. Теперь можно привязать.`, false);
        };

        async function submitTelegramBind(event) {
            event.preventDefault();
            if (!telegramUser) {
                setStatus('Сначала подтвердите вход через Telegram.', true);
                return;
            }

            const password = passwordInput.value.trim();
            if (!password) {
                setStatus('Введите пароль для подтверждения.', true);
                return;
            }

            bindButton.disabled = true;
            setStatus('Выполняем привязку...', false);
            try {
                const payload = {
                    id: telegramUser.id,
                    firstName: telegramUser.first_name,
                    lastName: telegramUser.last_name,
                    username: telegramUser.username,
                    photoUrl: telegramUser.photo_url,
                    authDate: telegramUser.auth_date,
                    hash: telegramUser.hash,
                    password
                };

                const response = await fetch('/api/telegram/bind', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Не удалось привязать Telegram');
                }

                window.location.href = '@Model.SafeReturnUrl';
            } catch (error) {
                setStatus(error.message || 'Произошла ошибка', true);
            } finally {
                bindButton.disabled = false;
            }
        }
    </script>
</body>
</html>
