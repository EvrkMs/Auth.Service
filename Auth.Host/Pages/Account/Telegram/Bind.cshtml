@page
@model Auth.Host.Pages.Account.Telegram.BindModel
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env
@{
    ViewData["Title"] = "Привязка Telegram";
    Layout = null;
}

<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Ava Auth</title>
    <link rel="stylesheet" href="~/css/telegram-bind.css" asp-append-version="true" />
</head>
<body>
    <div class="layout">
        <div class="panel">
            <div class="heading">
                <h1 class="title">Привязка Telegram</h1>
                <p class="subtitle">
                    Подтвердите пароль и авторизуйтесь через Telegram, чтобы связать аккаунт
                </p>
            </div>

            @if (string.IsNullOrWhiteSpace(Model.BotUsername))
            {
                <div class="alert-error">
                    Telegram-бот не настроен. Обратитесь к администратору.
                </div>
            }
            else
            {
                <form class="form" onsubmit="return false;" id="bind-form">
                    @Html.AntiForgeryToken()
                    <div>
                        <label>Пароль</label>
                        <input id="password-input"
                               type="password"
                               class="input"
                               placeholder="Введите пароль"
                               required />
                        <p class="hint">
                            Пароль требуется для подтверждения привязки.
                        </p>
                    </div>

                    <div>
                        <p class="step">1. Авторизуйтесь через Telegram:</p>
                        <div class="telegram-widget" id="telegram-widget"></div>
                        <div id="widget-error" class="alert-warning" style="display:none; margin-top: 10px;">
                            Не удалось загрузить виджет Telegram. Попробуйте отключить блокировщики или перейти напрямую:
                            <a style="color: #fde68a;" href="https://t.me/@Model.BotUsername" target="_blank" rel="noopener">https://t.me/@Model.BotUsername</a>
                        </div>
                    </div>

                    <div class="status-card">
                        <div id="tg-status-icon" class="status-icon">✓</div>
                        <div>
                            <p class="step" style="margin: 0 0 4px;">
                                2. Нажмите «Привязать Telegram» после успешной авторизации.
                            </p>
                            <p id="status" class="status-text">
                                Telegram пока не подтверждён.
                            </p>
                        </div>
                    </div>

                    <div class="actions">
                        <button id="bind-button" type="submit" class="btn-primary" disabled>
                            Привязать Telegram
                        </button>
                        <a class="back-link" href="@Model.SafeReturnUrl">
                            Вернуться назад
                        </a>
                    </div>
                </form>
            }
        </div>
    </div>

    <script src="~/js/telegram-bind.js"
            asp-append-version="true"
            data-safe-return-url="@Model.SafeReturnUrl"
            data-dev="@(Env.IsDevelopment().ToString().ToLower())"
            data-bot-username="@Model.BotUsername"></script>
</body>
</html>
